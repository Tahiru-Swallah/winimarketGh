<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Document</title>
</head>
<body>
    <form action="" id="orderForm">
        <input type="hidden" name="product_id" id="product_id">
        <input type="text" id="address" placeholder="Address" required> <br> <br>  
        <input type="text" id="postal_code" placeholder="Postal Code" required> <br> <br>
        <input type="text" id="city" placeholder="City"> <br> <br>
        <button type="submit">Place Order</button>
    </form> 

    <div id="order-result"></div> <br> 

    <div id="order-list"></div>

    <select id="payment-method">
        <option value="card">Card</option>
        <option value="mobile_money_mtn">MTN Mobile Money</option>
        <option value="mobile_money_airtel">Airtel Money</option>
        <option value="mobile_money_telecel">Telecel Money</option>
    </select>
    
    <div id="payment-status"></div>


    <script>
        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const selectedProduct = sessionStorage.getItem('selectedProduct');
            if (selectedProduct) {
                document.getElementById('product_id').value = selectedProduct;
                sessionStorage.removeItem('selectedProduct'); // Clear after use
            }
        });

        document.getElementById('orderForm').addEventListener('submit', async function(e){
            e.preventDefault()

            const productId = document.getElementById('product_id').value
            const address = document.getElementById('address').value
            const postalCode = document.getElementById('postal_code').value
            const city = document.getElementById('city').value

            const orderData = {product_id: productId, address: address, postal_code: postalCode, city: city}

            try{
                const response = await fetch('/order/api/order/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({address: address, postal_code: postalCode, city: city})
                })

                const data = await response.json()

                console.log("order data:", data)

                if (response.ok){
                    document.getElementById('order-result').innerHTML = `
                        <p>Order created successfully</p>
                        <p>Order ID: ${data.id}</p>
                        <p>Total Price: ${data.total_price}</p>
                    `
                } else {
                    document.getElementById('order-result').innerHTML = `
                        <p style="color: red;">Error: ${data.error || 'sorry!!, placing order failed'}</p>
                    `
                }

                await directPurchase(orderData)

                e.target.reset()
            } catch(error){
                console.error('Something went wrong: ' + error)
            }
        })

        async function directPurchase(data){
            try{

                const response = await fetch('/order/direct/purchase/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(data)
                })
    
                if(!response.ok){
                    throw new Error('Failed to place order')
                }

                const data = await response.json()
                console.log("Direct purchase data:", data)

            } catch(error){
                console.error('Something went wrong: ' + error)
            }
        }

        document.addEventListener('DOMContentLoaded', async function () {
            const orderList = document.getElementById('order-list')
            
            try{
                const response = await fetch('/order/api/get/order/')

                if(!response.ok){
                    throw new Error('Failed to fetch orders')
                }

                const data = await response.json()
                console.log(data)
                
                let total = 0
                orderList.innerHTML = ''

                data.forEach(order => {
                    let itemsHTML = ""

                    order.items.forEach(item => {
                        itemsHTML += `
                            <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                                <img src="${item.product.images[0]?.image}" 
                                    alt="${item.product.name}" 
                                    style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">
                                <div>
                                    <strong>${item.product.name}</strong><br>
                                    $${item.price} x ${item.quantity} <br>

                                    <strong>Status: ${order.status}</strong>
                                </div>
                            </div>
                        `
                    })

                    const orderDiv = document.createElement('div')
                    orderDiv.innerHTML = `
                        ${itemsHTML}
                        <p>Total Price: $${order.total_price}</p>
                        <button class="cancel-order" data-id="${order.id}">Cancel Order</button>
                        <hr>
                        <button class="pay-now" data-order-id="${order.id}">Pay Now</button>
                    `
                    orderList.appendChild(orderDiv)
                })

                /* attachCancelListeners() */
            } catch(error){
                console.error('Something went wrong ' + error)
            }
        })

        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', async (e) => {
                if (e.target.classList.contains('pay-now')) {
                    e.preventDefault();
                    const orderId = e.target.getAttribute('data-order-id');
                    const paymentMethod = document.getElementById('payment-method')?.value;

                    console.log("Clicked Pay Now for order:", orderId); // Debug log

                    await initializePayment(orderId, paymentMethod);
                }
            });
        });

        async function initializePayment(orderId, paymentMethod) {
            try {
                console.log("Initializing payment for:", orderId, "with method:", paymentMethod); // Debug log

                const response = await fetch(`/payment/initialize-payment/${orderId}/`, {
                    method: 'POST',
                    headers: {
                        "X-CSRFToken": getCSRFToken(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({payment_method: paymentMethod})
                });

                const data = await response.json();
                console.log("Payment response:", data); // Debug log

                const paymentStatusDiv = document.getElementById('payment-status');
                paymentStatusDiv.innerText = '';

                if (response.ok && data.authorization_url) {
                    window.location.href = data.authorization_url;
                } else {
                    paymentStatusDiv.innerText = data.error || 'Payment initialization failed';
                }
            } catch (error) {
                console.error('Payment initialization failed:', error);
            }
        }

        async function cancelOrder(orderId) {
            try {
                const response = await fetch(`/order/cancel/order/${orderId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken(),
                    },
                });

                if (!response.ok) throw new Error('Failed to cancel order');
                const result = await response.json();
                alert(result.message || 'Order cancelled successfully');
                window.location.reload() // Reload order list
            } catch (error) {
                console.error('Error cancelling order:', error);
                alert('Failed to cancel order');
            }
        }

        function attachCancelListeners() {
            document.querySelector('.cancel-order').addEventListener('click', (e) => {
                const orderId = e.currentTarget.getAttribute('data-id')
                cancelOrder(orderId)
            })
        }
    </script>
</body>
</html>