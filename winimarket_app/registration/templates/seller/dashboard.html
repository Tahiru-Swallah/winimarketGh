{% extends "base.html" %}
{% load static %}

{% block title %}Seller Dashboard | WiniMarket{% endblock %}

{% block content %}
<div class="seller-dashboard">

  <!-- HEADER -->
  <div class="seller-header">
    <div>
      <h2>Seller Dashboard</h2>
      <p class="store-name"></p>
    </div>
    <span class="badge verified"></span>
  </div>

  <!-- STATS -->
  <div class="seller-stats">
    <div class="stat-card">
      <h3 id="total-products">0</h3>
      <p>Products</p>
    </div>
    <div class="stat-card">
      <h3 id="pending-orders">0</h3>
      <p>Pending Orders</p>
    </div>
    <div class="stat-card">
      <h3 id="paid-orders">0</h3>
      <p>Paid Orders</p>
    </div>
    <div class="stat-card">
      <h3 id="completed-orders">0</h3>
      <p>Complete Orders</p>
    </div>
  </div>

  <!-- SELLER ADDRESS -->
    <section class="seller-section">
    <div class="section-header">
        <h3>Store Location</h3>
        <a href="#" id="openEditAddress" class="edit-link">Edit</a>
    </div>

    <div class="seller-address-card" id="seller-address">
        <p class="muted">Loading address‚Ä¶</p>
    </div>
    </section>

  <!-- ORDERS -->
  <section class="seller-section">
    <div class="section-header">
      <h3>Recent Orders</h3>
    </div>

    <div id="seller-orders" class="orders-list">
      <!-- Orders via AJAX -->
    </div>
  </section>

  <!-- PRODUCTS -->
  <section class="seller-section">
    <div class="section-header">
      <h3>My Products</h3>
    </div>

    <div id="seller-products" class="products-grid">
      <!-- Products via AJAX -->
    </div>
  </section>

</div>

<!-- Floating Button (Mobile) -->
<a href="/product/upload/" class="fab">+</a>

<!-- EDIT ADDRESS MODAL -->
<div id="editAddressModal" class="modal hidden">
  <div class="modal-overlay" id="closeAddressModal"></div>

  <div class="modal-content">
    <h3>Edit Store Address</h3>

    <form id="editAddressForm">

      <div class="form-group">
        <label>Region</label>
        <input type="text" id="editRegion" required>
      </div>

      <div class="form-group">
        <label>City</label>
        <input type="text" id="editCity" required>
      </div>

      <div class="form-group">
        <label>Campus</label>
        <input type="text" id="editCampus" placeholder="UEW - Winneba">
      </div>

      <div class="form-group">
        <label>Campus Area</label>
        <select id="editCampusArea">
          <option value="North Campus">North Campus</option>
          <option value="South Campus">South Campus</option>
          <option value="Central Campus">Central Campus</option>
        </select>
      </div>

      <div class="form-group">
        <label>Hall / Hostel</label>
        <input type="text" id="editHall">
      </div>

      <div class="form-group">
        <label>Landmark</label>
        <input type="text" id="editLandmark">
      </div>

      <div class="modal-actions">
        <button type="button" class="secondary-btn" id="cancelAddressEdit">
          Cancel
        </button>
        <button type="submit" class="primary-btn">
          Save Address
        </button>
      </div>

    </form>
  </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', async ()=> {
        await fetchSellerStats()
        await fetchSellerOrders()
        await fetchSellerProducts()
        await fetchSellerAddress()
    })

    async function fetchSellerStats(){
        try{

            const response = await fetch('/api/seller/dashboard/stats/', {
                headers: {
                    'X-CSRFToken': getCSRFToken(),
                }
            })

            if (!response.ok) throw new Error('Failed to load stats')

            const data = await response.json()
            renderStats(data)

        } catch(error){
            console.error(error)
            showToast("Unable to load seller stats", "error")
        }
    }

    function renderStats(data) {
        document.getElementById('total-products').textContent = data.total_products
        document.getElementById('pending-orders').textContent = data.pending_orders
        document.getElementById('paid-orders').textContent = data.paid_orders
        document.getElementById('completed-orders').textContent = data.complete_orders

        // Store name & verification
        document.querySelector('.store-name').textContent = data.store_name

        const badge = document.querySelector('.badge')
        if (data.is_verified) {
            badge.textContent = 'Verified'
            badge.classList.add('verified')
        } else {
            badge.textContent = 'Unverified'
            badge.classList.remove('verified')
        }
    }

    async function fetchSellerOrders() {
        try {
            const res = await fetch('/order/api/orders/seller/')

            if (!res.ok) throw new Error('Failed to load orders')

            const orders = await res.json()
            renderOrders(orders)

        } catch (error) {
            console.error(error)
            showToast('Unable to load orders', 'error')
        }
    }

    function renderOrders(orders) {
        const container = document.getElementById('seller-orders')
        container.innerHTML = ''

        if (!orders.length) {
            container.innerHTML = `<p class="empty">No recent orders</p>`
            return
        }

        orders.forEach(order => {
            container.innerHTML += `
                <div class="order-row">
                    <div>
                        <strong>#${order.id.slice(0, 8)}</strong>
                        <p>${order.buyer.full_name}</p>
                    </div>

                    <span class="status ${order.status}">
                        ${order.status.replace('_', ' ')}
                    </span>

                    <strong>‚Çµ${order.total_cost}</strong>

                    <a href="/order/seller/${order.id}/order/" class="link">
                        View
                    </a>
                </div>
            `
        })
    }

    async function fetchSellerProducts() {
        try {
            const res = await fetch('/api/seller/products/')

            if (!res.ok) throw new Error('Failed to load products')

            const products = await res.json()
            renderProducts(products)

        } catch (error) {
            console.error(error)
            showToast('Unable to load products', 'error')
        }
    }

    function renderProducts(products) {
        const grid = document.getElementById('seller-products')
        grid.innerHTML = ''

        if (!products.length) {
            grid.innerHTML = `
                <div class="empty-state">
                    <p>You haven‚Äôt uploaded any products yet.</p>
                    <a href="/product/upload/" class="primary-btn small">Add Product</a>
                </div>
            `;
            return;
        }

        products.forEach(product => {
            grid.innerHTML += `
                <div class="product-card-sell" data-id=${product.id}>
                    <img src="${product.images[0]?.image}" alt="${product.name}">

                    <div class="product-card-content">
                        <h4>${product.name}</h4>
                        <p>‚Çµ${product.price}</p>
                    </div>

                    <div class="product-actions">
                        <button class="btn-edit" data-id=${product.id}>Edit</button>
                        <button class="btn-delete" data-id=${product.id}>Delete</button>
                    </div>
                </div>
            `
        })
    }

    document.getElementById('seller-products').addEventListener('click', (e) => {
        const editBtn = e.target.closest('.btn-edit');
        const deleteBtn = e.target.closest('.btn-delete');

        if (editBtn) {
            const productId = editBtn.dataset.id;
            window.location.href = `/product/seller/edit/?id=${productId}`;
        }

        if (deleteBtn) {
            const productId = deleteBtn.dataset.id;
            confirmDeleteProduct(productId, deleteBtn);
        }
    });

    async function confirmDeleteProduct(productId, buttonEl){
        if (!productId) return;

        const productCard = buttonEl.closest('.product-card-sell');

        const confirmed = confirm(
            'Are you sure you want to delete this product?\nThis action cannot be undone.'
        );

        if (!confirmed) return;

        // OPTIMISTIC UI ‚Äî remove immediately
        productCard.style.opacity = '0.5';
        productCard.style.pointerEvents = 'none';

        try {
            const response = await fetch(`/api/seller/product/delete/${productId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                }
            });

            if (!response.ok) {
                throw new Error('Failed to delete product');
            }

            // Remove permanently
            productCard.remove();
            showToast('Product deleted successfully üóëÔ∏è', 'success');

            // Optional: update product count
            updateProductStats(-1);

            await fetchSellerProducts()

        } catch (error) {
            console.error(error);

            // ROLLBACK UI
            productCard.style.opacity = '1';
            productCard.style.pointerEvents = 'auto';

            showToast('Unable to delete product. Try again.', 'error');
        }
    }

    function updateProductStats(change = 0) {
        const totalProducts = document.getElementById('total-products');
        if (!totalProducts) return;

        totalProducts.textContent =
            Math.max(0, parseInt(totalProducts.textContent) + change);
    }

    async function fetchSellerAddress() {
        try {
            const res = await fetch('/account/api/get/seller-address/');
            if (!res.ok) throw new Error('Failed to load address');

            const address = await res.json();
            renderSellerAddress(address);

        } catch (err) {
            console.error(err);
            document.getElementById('seller-address').innerHTML =
                `<p class="muted">Address not set</p>`;
        }
    }

    function renderSellerAddress(address) {
        const container = document.getElementById('seller-address');

        container.innerHTML = `
            <div class="address-row">
                <span>üìç</span>
                <strong>${address.city}, ${address.region}</strong>
            </div>

            <div class="address-row">
                <span>üè´</span>
                ${address.campus} ‚Äì ${address.campus_area}
            </div>

            ${address.hall_or_hostel ? `
            <div class="address-row">
                <span>üè†</span>
                ${address.hall_or_hostel}
            </div>` : ''}

            ${address.landmark ? `
            <div class="address-row">
                <span>üß≠</span>
                ${address.landmark}
            </div>` : ''}
        `;
    }

    const editAddressModal = document.getElementById('editAddressModal');

    document.getElementById('openEditAddress').addEventListener('click', async (e) => {
        e.preventDefault();
        await loadAddressIntoForm();
        editAddressModal.classList.remove('hidden');
    });

    document.getElementById('closeAddressModal').onclick =
    document.getElementById('cancelAddressEdit').onclick = () => {
        editAddressModal.classList.add('hidden');
    };

    async function loadAddressIntoForm() {
        const res = await fetch('/account/api/get/seller-address/');
        if (!res.ok) return;

        const a = await res.json();

        document.getElementById('editRegion').value = a.region || '';
        document.getElementById('editCity').value = a.city || '';
        document.getElementById('editCampus').value = a.campus || '';
        document.getElementById('editCampusArea').value = a.campus_area || 'North Campus';
        document.getElementById('editHall').value = a.hall_or_hostel || '';
        document.getElementById('editLandmark').value = a.landmark || '';
    }

    document.getElementById('editAddressForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const payload = {
            country: 'Ghana',
            region: editRegion.value.trim(),
            city: editCity.value.trim(),
            campus: editCampus.value.trim(),
            campus_area: editCampusArea.value,
            hall_or_hostel: editHall.value.trim(),
            landmark: editLandmark.value.trim(),
        };

        try {
            const res = await fetch('/account/api/seller-address/', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
                body: JSON.stringify(payload)
            });

            if (!res.ok) throw await res.json();

            showToast('Address updated successfully ‚úÖ', 'success');
            editAddressModal.classList.add('hidden');
            fetchSellerAddress(); // refresh card

        } catch (err) {
            console.error(err);
            showToast(err.detail || 'Failed to update address', 'error');
        }
    });

</script>
{% endblock %}
