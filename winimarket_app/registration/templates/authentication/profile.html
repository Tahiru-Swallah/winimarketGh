<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Document</title>
</head>
<body>
    <form action="" id="roleForm">
        <h2>Choose Your Role</h2>
        <p>Please select your role to continue:</p>
        <label>
        <input type="radio" name="role" value="buyer" checked> Buyer
        </label> <br>
        <label>
            <input type="radio" name="role" value="seller"> Seller
        </label> <br>
        <button type="submit">Next</button>
    </form>

    <form action="" id="buyerProfileForm" style="display: none;">
        <h2>Buyer Form</h2>
        <input type="text" id="buyerFullName" name="full_name" placeholder="Full Name" required><br>
        <input type="file" id="buyerProfilePicture" name="profile_picture" accept="image/*"><br>
        <button type="submit">Finish</button>
    </form>

    <form action="" id="sellerProfileForm" style="display:none;">
        <h2>Seller Form</h2>
        <input type="text" id="storeName" name="store_name" placeholder="Store Name" required><br>
        <input type="file" id="storeLogo" name="store_logo" accept="image/*"><br>
        <textarea id="storeDescription" name="store_description" placeholder="Store Description"></textarea><br>
        <input type="text" id="businessAddress" name="business_address" placeholder="Business Address"><br>
        <input type="text" id="momoDetails" name="momo_details" placeholder="Momo Details"><br>
        <button type="submit">Finish</button>
    </form>

    <script>
        function showBuyerProfileForm() {
            document.getElementById('roleForm').style.display = 'none';
            document.getElementById('buyerProfileForm').style.display = 'block';
            document.getElementById('sellerProfileForm').style.display = 'none';
        }

        function showSellerProfileForm() {
            document.getElementById('roleForm').style.display = 'none';
            document.getElementById('buyerProfileForm').style.display = 'none';
            document.getElementById('sellerProfileForm').style.display = 'block';
        }

        let selectedRole = 'buyer'; // Default role
        document.getElementById('roleForm').addEventListener('change', function(e){
            if (e.target.name === 'role'){
                selectedRole = e.target.value
            }
        })

        document.getElementById('roleForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const role = document.querySelector('input[name="role"]:checked').value;
            if (role === 'buyer') {
                showBuyerProfileForm();
            } else {
                showSellerProfileForm();
            }
        });

        document.getElementById('buyerProfileForm').addEventListener('submit', async function(e){
            e.preventDefault();
            const role = 'buyer';
            await submitProfile(role);
        })

        document.getElementById('sellerProfileForm').addEventListener('submit', async function(e){
            e.preventDefault();
            await submitSellerProfile();
        })

        function getCSRFToken() {
            return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        }

        async function submitProfile(role){
            const formData = new FormData();
            formData.append('role', role);
            formData.append('full_name', document.getElementById('buyerFullName').value);
            const pic = document.getElementById('buyerProfilePicture').files[0];

            if (pic) {
                formData.append('profile_picture', pic);
            }

            try{
                const response = await fetch('/account/api/profile/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: formData
                })

                const data = await response.json();

                if (response.ok) {
                    alert('Profile submitted successfully');
                    // Redirect or show success message
                    window.location.href = '/account/';
                } else {
                    alert('Profile error: ' + JSON.stringify(data));
                }
            } catch (error) {
                console.error('Error submitting profile:', error);
            }
        }

        async function submitSellerProfile(){
            /* 1. Update profile role to seller */

            const profileFormData = new FormData()
            profileFormData.append('role', 'seller');
            
            let profileUpdate = await fetch('/account/api/profile/', {
                method: 'PUT',
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                body: profileFormData
            });

            if (!profileUpdate.ok){
                alert('Could not update profile role to seller');
                return;
            }

            /* 2. Submit seller profile */
            const formData = new FormData();
            formData.append('role', 'seller');
            formData.append('store_name', document.getElementById('storeName').value);
            const logo = document.getElementById('storeLogo').files[0];
            if (logo) {
                formData.append('store_logo', logo);
            }
            formData.append('store_description', document.getElementById('storeDescription').value);
            formData.append('business_address', document.getElementById('businessAddress').value);
            formData.append('momo_details', document.getElementById('momoDetails').value);

            try{
                const response = await fetch('/account/api/seller-profile/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: formData
                })

                const data = await response.json();

                if (response.ok) {
                    alert('Seller profile submitted successfully');
                    // Redirect or show success message
                    window.location.href = '/account/';
                } else {
                    alert('Profile error: ' + JSON.stringify(data));
                }

            } catch (error) {
                console.error('Error submitting seller profile:', error);
            }
        }
    </script>
</body>
</html>