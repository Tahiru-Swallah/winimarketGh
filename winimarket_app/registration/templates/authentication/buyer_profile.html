{% extends "base.html" %}
{% load static %}

{% block title %}My Profile | WiniMarket{% endblock %}

{% block content %}
<div class="profile-container">

  <h2>My Profile</h2>

  <form id="buyerProfileForm" enctype="multipart/form-data">

    <div class="avatar-section">
      <label for="avatarInput" class="avatar-wrapper">
        <img id="avatarPreview" src="{% if profile.profile_picture %}{{ profile.profile_picture.url }}{% else %}{% static 'images/profile1.jfif' %}{% endif %}" alt="Profile Picture">

        <span class="avatar-overlay">
          <i class="bx bx-camera"></i>
        </span>
      </label>

      <input type="file" id="avatarInput" name="avatar" accept="image/*" hidden>
    </div>

    <div class="form-group">
      <label>Full Name</label>
      <input type="text" name="full_name" value="{{ profile.full_name }}" required>
    </div>

    <button type="submit" class="primary-btn">
      Save Profile
    </button>

  </form>
</div>

<script>
  const avatarInput = document.getElementById('avatarInput')
  const avatarPreview = document.getElementById('avatarPreview')

  avatarInput.addEventListener('change', () => {
    const file = avatarInput.files[0]
    if (!file) return

    const reader = new FileReader()
    reader.onload = () => {
      avatarPreview.src = reader.result
    }
    reader.readAsDataURL(file)
  })

  const form = document.getElementById('buyerProfileForm')

  form.addEventListener('submit', async e => {
    e.preventDefault()

    const formData = new FormData(form)

    try {
      const res = await fetch('/account/api/profile/', {
        method: 'PATCH',
        headers: {
          'X-CSRFToken': getCSRFToken()
        },
        body: formData
      })

      if (!res.ok) throw new Error()

      showToast('Profile updated successfully', 'success')
      setTimeout(() => window.location.href = '/', 1000)

    } catch {
      showToast('Unable to update profile', 'error')
    }
  })
</script>
{% endblock %}
